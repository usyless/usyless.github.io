var aa=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};function ba(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");}var ca=ba(this);
function ea(a,b){if(b)a:{var c=ca;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))break a;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&b!=null&&aa(c,a,{configurable:!0,writable:!0,value:b})}}
ea("String.prototype.replaceAll",function(a){return a?a:function(b,c){if(b instanceof RegExp&&!b.global)throw new TypeError("String.prototype.replaceAll called with a non-global RegExp argument.");return b instanceof RegExp?this.replace(b,c):this.replace(new RegExp(String(b).replace(/([-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1").replace(/\x08/g,"\\x08"),"g"),c)}});var f=!0;const fa=[],ha=[];let ia;
async function h(a,{A:b=[],buttons:c,v:d=[],onclose:e,F:m,C:n}={}){n||r();f=!1;return new Promise(k=>{const g=document.createElement("div"),l=document.createElement("div"),u=document.createElement("div");g.setAttribute("usy-overlay","");g.classList.add("fullscreen","blur");l.classList.add("popupOuter",...d);u.classList.add("popupInner",...d);const p=[];if(typeof a==="string"){var B=document.createElement("div");B.classList.add("popupText");B.textContent=a;p.push(B)}else Array.isArray(a)?p.push(...a):
p.push(a);l.appendChild(u);if(typeof c==="string"||c==null){B=document.createElement("div");B.classList.add("popupButtons");const q=document.createElement("button");q.classList.add("standardButton");q.textContent=c??"Ok";B.appendChild(q);q.addEventListener("click",()=>{const P=a.D?.();n?r(null,g):r();k(P??!0)});ia=q}else B=c;u.append(...p,B);g.addEventListener("click",q=>{q.target===q.currentTarget&&(n?r(null,g):r(),k(!1))});g.appendChild(l);b.push({target:window,type:"keydown",listener:q=>{q.key.toLowerCase()===
"escape"&&g.click()}});for(const q of b)fa.push(q),q.target.addEventListener(q.type,q.listener);e!=null&&ha.push(e);m?.(g);document.body.appendChild(g)})}function r(a,b=null){if(b)b.remove();else{f=!0;for(const c of fa)c.target?.removeEventListener?.(c.type,c.listener);for(const c of ha)c();ha.length=0;fa.length=0;document.querySelectorAll("[usy-overlay]").forEach(c=>c.remove())}};const t={FRHigher:2E4,FRLower:20,colourTolerance:67,line_move_speed:100,PPO:48,delimitation:"tab",lowFRExport:20,highFRExport:2E4,SPLHigher:"",SPLLower:""};document.getElementById("restoreDefault").addEventListener("click",()=>{ja();h("Restored settings to default")});function ja(){for(const a in t)document.getElementById(a).value=t[a]}const v=document.createElement("canvas"),w=v.getContext("2d");let x,y,z,ka,A=null,C=null;const D=document.getElementById("glass");D.l=D.querySelector("img");
D.I=a=>{D.style.borderColor=`rgb(${a})`};D.B=()=>{E.m()&&(D.l.src=E.src,D.l.width=E.clientWidth*3,D.l.height=E.clientHeight*3)};
var la=()=>{document.querySelector('.waiting-overlay[data-for="trace"]').classList.remove("enabled")},F=document.getElementById("lines"),G={xHigh:document.getElementById("xHigh"),xLow:document.getElementById("xLow"),yHigh:document.getElementById("yHigh"),yLow:document.getElementById("yLow")},ma=(a,b)=>{const c=a.dataset.direction;a.nextElementSibling.setAttribute(c,b);a.setAttribute(`${c}1`,b);a.setAttribute(`${c}2`,b)},na=()=>{for(const a of F.querySelectorAll("line"))a.setAttribute("stroke-width",
x);for(const a of F.querySelectorAll("text"))a.setAttribute("font-size",`${1.3*x}em`)},H=a=>parseFloat(a.getAttribute(`${a.dataset.direction}1`)),I=(a,b)=>{const c=H(G[a.dataset.other]),d=a.dataset.direction==="x"?y:z;a===G.xHigh||a===G.yLow?ma(a,Math.max(c+1,Math.min(d-1,b))):ma(a,Math.max(1,Math.min(c-1,b)))},J=()=>F.classList.remove("hidden"),K=()=>F.classList.add("hidden"),oa=()=>{for(const a of L){const [b,c]=a.dataset.direction==="x"?["y",z]:["x",y];a.setAttribute(`${b}1`,"0");a.setAttribute(`${b}2`,
c)}G.xHigh.nextElementSibling.setAttribute("y",(z/2).toString());G.xLow.nextElementSibling.setAttribute("y",(z/2).toString());G.yHigh.nextElementSibling.setAttribute("x",(y/2).toString());G.yLow.nextElementSibling.setAttribute("x",(y/2).toString())},L=[G.xHigh,G.xLow,G.yHigh,G.yLow],qa=()=>{pa.classList.remove("hidden");M.setAttributeNS(null,"width","0")},ra=()=>{document.getElementById("erasing").classList.add("hidden")},pa,M,N;pa=document.getElementById("erasing");M=pa.firstElementChild;
const E=document.getElementById("uploadedImage");E.i=a=>{const b=E.getBoundingClientRect(),c=a.clientX;a=a.clientY;return{x:c,y:a,xRel:c-b.left,yRel:a-b.top}};E.m=()=>E.src.startsWith("blob:");E.H=()=>{const a=O.get(E.src),b={};if(a){for(const c in G)b[c]=H(G[c]);a.lines=b}};E.G=()=>{const a=O.get(E.src).lines;for(const b in G)I(G[b],a[b]);oa();J()};
const Q=(()=>{const a=document.getElementById("SPLHigher"),b=document.getElementById("SPLLower"),c=document.getElementById("FRHigher"),d=document.getElementById("FRLower"),e=document.getElementById("snapToLines"),m=document.getElementById("line_move_speed"),n=document.getElementById("colourTolerance"),k=document.getElementById("PPO"),g=document.getElementById("delimitation"),l=document.getElementById("lowFRExport"),u=document.getElementById("highFRExport");return{SPLHigher:()=>a.value,SPLLower:()=>
b.value,FRHigher:()=>c.value,FRLower:()=>d.value,snapToLines:()=>e.checked,line_move_speed:()=>parseInt(m.value,10)||t.line_move_speed,colourTolerance:()=>parseInt(n.value,10)||t.colourTolerance,PPO:()=>k.value||t.PPO,delimitation:()=>g.value||t.delimitation,lowFRExport:()=>l.value||t.lowFRExport,highFRExport:()=>u.value||t.highFRExport}})(),sa=a=>{h(a).then(()=>sa(a)).catch(()=>sa(a))};
var ta=()=>{for(const a of document.querySelectorAll("#sidebar [data-default]"))a.textContent=a.dataset["default"];A=null;C?.()},ua=a=>{document.getElementById("undo").disabled=!a.undo;document.getElementById("redo").disabled=!a.redo};
const va=["selectPath","selectPoint","eraseRegion"],wa={path:K,point:K,erase:()=>{K();qa()}},xa={path:J,point:J,erase:()=>{ra();J()}},ya=a=>{a=a.target;const b=a.dataset.mode,c=JSON.parse(JSON.stringify(A));ta();c===b?(C?.(),A=null):(a.textContent=a.dataset.active,C?.(),C=xa[b],A=b,wa[b]())};for(const a of va)document.getElementById(a).addEventListener("click",ya);
var Aa=(()=>{const a=new Worker("./usytrace.js",{type:"module"});a.onmessage=b=>{b=b.data;var c=b.type;switch(c){case "exportTrace":c=document.createElement("div");const d=document.createElement("div"),e=document.createElement("input");d.textContent="Export file name";e.placeholder="trace";e.type="text";e.classList.add("sidebarSection");c.append(d,e);c.classList.add("exportBox");c.D=()=>e.value;h(c,{buttons:"Save Trace",A:[{target:document,type:"keydown",listener:m=>{m.key.toLowerCase()==="enter"&&
ia.click()}}]}).then(m=>{if(m!==!1){const n=document.createElement("a"),k=URL.createObjectURL(new Blob([b["export"]],{type:"text/plain;charset=utf-8"}));n.href=k;n.classList.add("hidden");document.body.appendChild(n);!m?.endsWith(".txt")&&m?.length>0&&(m+=".txt");n.download=m||"trace.txt";n.click();setTimeout(()=>{URL.revokeObjectURL(k);document.body.removeChild(n)},5E3)}});setTimeout(()=>{e.focus()},50);break;case "error":la();sa(b.message);break;case "getHistoryStatus":ua(b);break;case "setData":console.timeEnd("Initialise image");
break;default:E.src===b.src&&(c==="getPixelColour"?D.I(b.pixelColour):c==="snapLine"?(I(G[b.line.name],b.line.position),b["final"]&&(H(G.xHigh)<y*.2&&I(G.xHigh,y),H(G.xLow)>y*.8&&I(G.xLow,0),H(G.yHigh)>z*.8&&I(G.yHigh,0),H(G.yLow)<z*.2&&I(G.yLow,z))):(za(b.svg),la(),R({type:"getHistoryStatus"})))}};return a})(),R=a=>E.m()&&Aa.postMessage({src:E.src,...a}),Ba=(a,b)=>{R({type:"eraseRegion",begin:a,end:b})},Ca=()=>{R({type:"autoTrace",colourTolerance:Q.colourTolerance()})},S=(a,b,c=!1)=>{R({type:"snapLine",
line:{name:a.id,position:H(a),direction:a.dataset.direction},direction:b,final:c})},za=a=>{var b=document.getElementById("trace");const c=b.lastElementChild;b=b.firstElementChild;c.setAttribute("d",a);c.setAttribute("stroke","#ff0000");c.setAttribute("stroke-width",ka);b.setAttribute("d",a);b.setAttribute("stroke-width",(ka*1.5).toString())};document.getElementById("autoPath").addEventListener("click",Ca);document.getElementById("undo").addEventListener("click",()=>R({type:"undoTrace"}));
document.getElementById("redo").addEventListener("click",()=>R({type:"redoTrace"}));document.getElementById("clearPath").addEventListener("click",()=>R({type:"clearTrace"}));
document.getElementById("export").addEventListener("click",()=>{const a=c=>Object.values(c).some(d=>d&&typeof d==="object"?a(d):d==null||d===""),b={type:"exportTrace",PPO:Q.PPO(),delim:Q.delimitation(),lowFR:Q.lowFRExport(),highFR:Q.highFRExport(),SPL:{top:Q.SPLHigher(),topPixel:H(G.yHigh),bottom:Q.SPLLower(),bottomPixel:H(G.yLow)},FR:{top:Q.FRHigher(),topPixel:H(G.xHigh),bottom:Q.FRLower(),bottomPixel:H(G.xLow)}};a(b)?h("Please fill in all required values to export (SPL and FR values)"):R(b)});
document.getElementById("smoothTrace").addEventListener("click",()=>R({type:"smoothTrace"}));const O=new Map,T=document.getElementById("fileInput");
var Da=document.getElementById("imageQueueInner"),U=()=>Da.querySelector("img.selectedImage"),Ea=a=>{O.delete(a.src);R({type:"removeImage",src:a.src});URL.revokeObjectURL(a.src);a.remove()},Fa=()=>{U()?.scrollIntoView({inline:"center",behavior:"smooth"})},Ha=(a,b=!1)=>{const c=document.createElement("img"),d=document.getElementById("imageQueueInner");c.src=a;O.set(c.src,{initial:!0});c.addEventListener("dragstart",e=>e.preventDefault());c.addEventListener("click",e=>{e.preventDefault();e.stopPropagation();
E.H();E.src=a;for(const m of Da.querySelectorAll("img.selectedImage"))m.classList.remove("selectedImage");c.classList.add("selectedImage");Fa()});c.o=e=>{e?.preventDefault();c.classList.contains("selectedImage")&&(e=c.nextElementSibling,e||(e=c.previousElementSibling),e?e.click():Ga());Ea(c)};c.addEventListener("contextmenu",c.o);d.appendChild(c);b&&(c.click(),setTimeout(Fa,50))};document.getElementById("removeImage").addEventListener("click",()=>U()?.o());
document.getElementById("toggleImageQueue").addEventListener("click",a=>{a=a.target;document.getElementById("imageContainer").addEventListener("transitionend",()=>window.dispatchEvent(new Event("resize")),{once:!0});a.textContent===a.dataset.active?(a.textContent=a.dataset["default"],a.removeAttribute("active")):(a.textContent=a.dataset.active,a.setAttribute("active",""))});
document.getElementById("editImage").addEventListener("click",()=>{if(E.m()){const d=document.createElement("div");var a=document.createElement("h3"),b=document.createElement("div"),c=document.createElement("div");const e=document.createElement("img");d.id="editContainer";d.append(a,b,c);c.append(e);c.classList.add("cropWrapper");e.draggable=!1;a.textContent="Edit Image";e.src=E.src;const m=new Set,n=!("filter"in CanvasRenderingContext2D.prototype);a=n?{Invert:"invert(1)"}:{Invert:{g:"invert",default:1,
unit:""},Brightness:{g:"brightness",default:120,unit:"%",description:"Enter value for brightness in %",validate:k=>Math.max(0,k)},Contrast:{g:"contrast",default:120,unit:"%",description:"Enter value for contrast in %",validate:k=>Math.max(0,k)},Saturate:{g:"saturate",default:120,unit:"%",description:"Enter value for saturation in %",validate:k=>Math.max(0,k)},Hue:{g:"hue-rotate",default:5,unit:"deg",description:"Enter value for hue rotation in degrees",validate:k=>Math.abs(k)%360}};for(const k in a){c=
document.createElement("button");c.textContent=k;c.classList.add("standardButton");b.appendChild(c);const g=a[k];c.addEventListener("click",()=>{if(m.has(k))m.delete(k),e.style.filter=e.style.filter.replaceAll(new RegExp(`${g.g}\\(.*\\)`,"g"),"");else if(g.validate){const l=document.createElement("input");l.placeholder=g.default;l.type="number";const u=[document.createTextNode(g.description),l];u.D=()=>l.value||g.default;h(u,{C:!0}).then(p=>{p!==!1&&Number.isFinite(Number(p))?(p=g.validate(p),m.add(k),
e.style.filter+=`${g.g}(${p}${g.unit})`):h("Invalid value.",{C:!0})})}else m.add(k),e.style.filter+=`${g.g}(${g.default}${g.unit})`})}b=document.createElement("div");b.classList.add("popupButtons");a=document.createElement("button");c=document.createElement("button");a.classList.add("standardButton");a.textContent="Cancel";c.classList.add("standardButton");c.textContent="Save";b.append(a,c);a.addEventListener("click",r);c.addEventListener("click",()=>{v.width=y;v.height=z;n||(w.filter=e.style.filter);
w.drawImage(e,0,0);if(n){console.log("Using fallback invert mode");const g=w.getImageData(0,0,y,z),l=g.data,u=l.length;for(let p=0;p<u;p+=4)l[p]=255-l[p],l[p+1]=255-l[p+1],l[p+2]=255-l[p+2];w.putImageData(g,0,0)}const k=U();v.toBlob(g=>{Ha(URL.createObjectURL(g),!0);k?.o();r()})},{once:!0});h(d,{buttons:b})}else h("No valid image selected")});ja();Ga();
T.u=a=>{a=Array.from(a).filter(c=>c.type.startsWith("image/"));const b=a.length-1;a.length>0?(r(),a.forEach((c,d)=>{Ha(URL.createObjectURL(c),d===b)})):h("Invalid image/file(s) added!");T.value=""};T.addEventListener("change",a=>{T.u(a.target.files)});E.addEventListener("dragstart",a=>a.preventDefault());document.getElementById("fileInputButton").addEventListener("click",()=>T.click());
document.addEventListener("paste",a=>{a.preventDefault();const b=new DataTransfer;for(const c of a.clipboardData.items)c.kind==="file"&&b.items.add(c.getAsFile());b.files.length>0&&T.u(b.files)});V("dragover",document.body,a=>{a.preventDefault();a.dataTransfer.dropEffect="copy";document.body.classList.add("lowOpacity")});V(["dragleave","dragend"],document.body,a=>{a.preventDefault();document.body.classList.remove("lowOpacity")});
V("drop",document.body,a=>{a.preventDefault();document.body.classList.remove("lowOpacity");T.u(a.dataTransfer.files)});
E.addEventListener("pointermove",a=>{if(A!=="erase"){a.preventDefault();const b=E.parentElement,c=b.getBoundingClientRect();a=E.i(a);D.style.left=`${Math.min(a.x-c.left,b.clientWidth-D.clientWidth)}px`;D.style.top=`${Math.min(a.y-c.top,b.clientHeight-D.clientHeight)}px`;D.l.style.left=`${(a.xRel*3-D.clientWidth/2)*-1}px`;D.l.style.top=`${(a.yRel*3-D.clientHeight/2)*-1}px`;R({type:"getPixelColour",x:a.xRel*x,y:a.yRel*x});D.classList.remove("hidden")}});
V(["pointerleave","pointerout","pointercancel"],E,()=>D.classList.add("hidden"));let W=null,Ia=E.i;F.addEventListener("pointerdown",a=>{const b=Ia(a);a={x:y*.02,y:z*.02};for(var c of L)c.offset=b[`${c.dataset.direction}Rel`]*x-H(c);c=L.reduce((d,e)=>Math.abs(e.offset)<Math.abs(d.offset)?e:d,L[0]);Math.abs(c.offset)<a[c.dataset.direction]&&(W=c)});F.addEventListener("pointermove",a=>{W&&I(W,Ia(a)[`${W.dataset.direction}Rel`]*x-W.offset)});
V(["pointerup","pointerleave","pointercancel"],F,a=>{a.preventDefault();W=null});let X,Ja,Ka=Q.snapToLines();document.getElementById("snapToLines").addEventListener("change",()=>Ka=Q.snapToLines());
document.getElementById("buttonSection").addEventListener("pointerdown",a=>{const b=a.target,c=b.parentNode;if(!X&&c.classList.contains("moveButtons"))if(a.preventDefault(),a=c.dataset["for"])if(Ja=G[a],Ka)S(G[c.dataset["for"]],parseInt(b.dataset.direction,10));else{const d=parseInt(b.dataset.direction,10);X=setInterval(()=>{I(Ja,H(Ja)+d*x)},100/Q.line_move_speed()*10)}else{const d=parseInt(b.dataset.direction,10);X=setInterval(()=>{R({type:"offsetTrace",direction:d,magnitude:x})},100/Q.line_move_speed()*
10)}});V(["pointerup","pointerleave","pointerout","pointercancel"],document.getElementById("buttonSection"),a=>{a.preventDefault();clearInterval(X);X=null});window.addEventListener("resize",()=>{x=y/E.clientWidth;na();D.B()});const La={path:(a,b)=>{R({type:"trace",x:a,y:b,colourTolerance:Q.colourTolerance()})},point:(a,b)=>R({type:"addPoint",x:a,y:b})};E.addEventListener("pointerup",a=>{A!=null&&(a=E.i(a),La[A]?.(a.xRel*x,a.yRel*x))});let Y=!1;
E.addEventListener("pointerdown",a=>{A==="erase"&&(a.preventDefault(),Y=!0,a=E.i(a).xRel*x,qa(),N=Math.max(Math.min(+a,y),0),M.setAttributeNS(null,"x",a),document.addEventListener("pointerup",Ma,{once:!0}))});E.addEventListener("pointermove",a=>{Y&&A==="erase"&&(a.preventDefault(),a=E.i(a).xRel*x,a=+a,a<N?(M.setAttributeNS(null,"width",`${N-a}px`),M.setAttributeNS(null,"x",a)):(M.setAttributeNS(null,"width",`${a-N}px`),M.setAttributeNS(null,"x",N.toString())))});
const Ma=a=>{Y&&A==="erase"&&(a.preventDefault(),Y=!1,a=E.i(a).xRel*x,a=Math.max(Math.min(+a,y),0),Ba(...(N<a?[N,a]:[a,N])),M.setAttributeNS(null,"width","0"))};
E.addEventListener("load",()=>{document.getElementById("defaultMainText").classList.add("hidden");for(var a of document.querySelectorAll("[data-disabled]"))a.disabled=!1;ta();y=E.naturalWidth;z=E.naturalHeight;ka=Math.max(y,z)*.003;x=y/E.clientWidth;ra();for(var b of document.querySelectorAll("svg"))b.setAttribute("width",y),b.setAttribute("height",z),b.setAttribute("viewBox",`0 0 ${y} ${z}`);za("");D.B();a=O.get(E.src);if(a.initial){document.querySelector('.waiting-overlay[data-for="trace"]').classList.add("enabled");
console.time("Initialise image");b=y;var c=z;v.width=b;v.height=c;w.drawImage(E,0,0);const d=w.getImageData(0,0,b,c);Aa.postMessage({src:E.src,type:"setData",data:d.data,width:b,height:c},[d.data.buffer]);I(G.xHigh,y);I(G.xLow,0);I(G.yHigh,0);I(G.yLow,z);oa();J();S(G.xHigh,-1);S(G.xLow,1);S(G.yHigh,1);S(G.yLow,-1,!0);Ca();a.initial=!1}else R({type:"setCurrent"}),E.G(),R({type:"getCurrentPath"});na()});E.addEventListener("error",()=>{if(E.m()){for(const a of U())Ea(a);h("Error loading this image, it may be malformed")}});
const Na=new PointerEvent("pointerdown",{bubbles:!0}),Oa=new PointerEvent("pointerup",{bubbles:!0}),Pa=document.getElementById("redo"),Qa=document.getElementById("undo"),Ra=document.getElementById("autoPath"),Sa=document.getElementById("selectPath"),Ta=document.getElementById("selectPoint"),Ua=document.getElementById("toggleImageQueue"),Va=document.getElementById("export"),Wa=document.getElementById("smoothTrace"),Xa=document.getElementById("editImage"),Ya=document.getElementById("eraseRegion"),Za=
document.getElementById("fileInputButton"),$a=document.getElementById("removeImage"),ab=document.getElementById("clearPath"),bb=document.querySelector('[data-id="offset_trace"] > [data-direction="1"]'),cb=document.querySelector('[data-id="offset_trace"] > [data-direction="0"]'),db=document.querySelector('[data-id="offset_trace"] > [data-direction="2"]'),eb=document.querySelector('[data-id="offset_trace"] > [data-direction="3"]'),fb=document.querySelector('[data-for="yLow"] > [data-direction="-1"]'),
gb=document.querySelector('[data-for="yLow"] > [data-direction="1"]'),hb=document.querySelector('[data-for="xLow"] > [data-direction="-1"]'),ib=document.querySelector('[data-for="xLow"] > [data-direction="1"]'),jb=document.querySelector('[data-for="yHigh"] > [data-direction="-1"]'),kb=document.querySelector('[data-for="yHigh"] > [data-direction="1"]'),lb=document.querySelector('[data-for="xHigh"] > [data-direction="-1"]'),mb=document.querySelector('[data-for="xHigh"] > [data-direction="1"]'),nb={z:a=>
a.ctrlKey&&(a.shiftKey?Pa:Qa).click(),a:()=>Ra.click(),t:()=>Sa.click(),p:()=>Ta.click(),h:()=>Ua.click(),s:a=>(a.ctrlKey?Va:Wa).click(),e:a=>(a.ctrlKey?Xa:Ya).click(),enter:()=>Za.click(),delete:()=>$a.click(),backspace:()=>ab.click(),arrowup:a=>(a.ctrlKey?bb:a.shiftKey?fb:jb).dispatchEvent(Na),arrowdown:a=>(a.ctrlKey?cb:a.shiftKey?gb:kb).dispatchEvent(Na),arrowleft:a=>(a.ctrlKey?db:a.shiftKey?hb:lb).dispatchEvent(Na),arrowright:a=>(a.ctrlKey?eb:a.shiftKey?ib:mb).dispatchEvent(Na)},ob={arrowup:a=>
(a.ctrlKey?bb:a.shiftKey?fb:jb).dispatchEvent(Oa),arrowdown:a=>(a.ctrlKey?cb:a.shiftKey?gb:kb).dispatchEvent(Oa),arrowleft:a=>(a.ctrlKey?db:a.shiftKey?hb:lb).dispatchEvent(Oa),arrowright:a=>(a.ctrlKey?eb:a.shiftKey?ib:mb).dispatchEvent(Oa)};document.addEventListener("keydown",a=>{if(f){const b=nb[a.key.toLowerCase()];!a.target.closest("input")&&b&&(a.preventDefault(),b(a))}});
document.addEventListener("keyup",a=>{if(f){const b=ob[a.key.toLowerCase()];!a.target.closest("input")&&b&&(a.preventDefault(),b(a))}});function V(a,b,c){for(const d of Array.isArray(a)?a:[a])b.addEventListener(d,c)}function Ga(){document.getElementById("defaultMainText").classList.remove("hidden");for(const a of document.querySelectorAll("[data-disabled]"))a.disabled=!0;ta();K();ra();za("");E.src=""}
const pb=a=>{a=a.target;parseInt(a.value,10)<a.min&&(a.value=a.min)},qb=a=>{a=a.target;parseInt(a.value,10)>a.max&&(a.value=a.max)};for(const a of["FRLower","colourTolerance","lowFRExport","line_move_speed"])document.getElementById(a).addEventListener("change",pb);for(const a of["line_move_speed"])document.getElementById(a).addEventListener("change",qb);const rb=[{j:"Welcome to UsyTrace",body:"<h2>Here you can trace frequency responses from images</h2>\n\nAll you need to know, as well as keybindings are on the next few pages"},{j:"Tracing",body:"<h3>Auto Trace (a)</h3>\nTries to automatically select a line in the image, may fail, applied automatically upon image import\n    \n<h3>Select Path (t)</h3>\nTraces to the right of the point you click on the image, can complete a trace by starting from the left side of the frequency response and clicking to the right if it misses a part\n\n<h3>Add Point (p)</h3>\nAdd a single point to the trace manually, useful for situations where Select Path or Auto Trace Fails\n\n<h3>Smooth Trace (s)</h3>\nSmooths out sudden bumps in the traced line, good for if the original image is bad and the traced line is inconsistent\n\n<h3>Undo (Ctrl + z)</h3>\nGoes back to the previous trace step, saves add point, tracing, and clearing history\n\n<h3>Redo (Ctrl + Shift + z)</h3>\nGoes back to recently undone trace steps\n\n<h3>Erase Region (e)</h3>\nSelect a region to erase a trace from by dragging a box around the area\n\n<h3>Clear Path (Backspace)</h3>\nClears the current trace on screen, can go back using Undo"},
{j:"Exporting",body:"Align <b>High</b> and <b>Low</b> lines with given values in their respective axis, then input the respective values into <b>Higher SPL</b>, <b>Lower SPL</b>, <b>Higher Frequency</b> and <b>Lower Frequency</b>.\n\nThe lines can be moved with the arrow keys, defaulting to the <b>High</b> line for each axis, but can control the <b>Low</b> line by holding <b>Shift</b>\n\n<h3>Trace Settings</h3>     \nAdjust the <b>Minimum Exported Frequency</b>, <b>Maximum Exported Frequency</b>, <b>Points Per Octave of the exported data</b>, and <b>the delimitation of the exported data</b>\n\nThen <b>Export Trace</b> will give you the result"},
{j:"Settings",body:"<h3>Buttons Snap To Axis</h3>\nwhether the buttons underneath the Export values will attempt to snap the lines to their axis, or to enable smooth manual movement\n    \n<h3>Colour Tolerance</h3>\nRaise if line is not being detected, Lower if line is jagged or detecting multiple lines"},{j:"Miscellaneous",body:"You can <b>drop</b>, or <b>choose any amount of images</b> you like into the site, other than with pasting, as that only supports one image at a time.\n\n<h3>Image Editing (Ctrl + e)</h3>\nHere you can apply filters to the image that may make it trace better.\n\n<h3>Image Queue</h3>\nLoaded images show in the image queue on the bottom, and can be removed by right-clicking them (long hold on mobile), pressing <b>Remove</b> or pressing the <b>Delete</b> key on your keyboard"}];
let Z=0;var sb;try{sb=parseInt(window.localStorage.getItem("USER_TUTORIAL_VERSION")??0,10)}catch{sb=0}3!==sb&&tb();
function tb(){function a(){Z>=rb.length-1?g.textContent="End Tutorial":Z<=0?(g.textContent="Begin Tutorial",l.disabled=!0,l.textContent=""):(g.textContent="Next",l.disabled=!1,l.textContent="Previous");b()}function b(){const u=rb[Z]??rb[0];m.textContent=u.j;k.innerHTML=u.body}Z=0;const c=document.createElement("div"),d=document.createElement("div");d.classList.add("popupButtons");c.classList.add("popupText");const e=document.createElement("div"),m=document.createElement("h1"),n=document.createElement("button");
e.classList.add("headContainer");n.classList.add("standardButton");n.textContent="\ud800\udf22";n.addEventListener("click",r);e.append(m,n);const k=document.createElement("p");c.append(k);const g=document.createElement("button"),l=document.createElement("button");g.classList.add("standardButton");l.classList.add("standardButton");g.addEventListener("click",()=>{Z>=rb.length-1&&n.click();++Z;a()});l.addEventListener("click",()=>{--Z;a()});a();b();d.append(l,g);h([e,c,d],{buttons:d,v:["fixedSize"],
onclose:ub})}function ub(){window.localStorage.setItem("USER_TUTORIAL_VERSION",(3).toString())}document.getElementById("tutorial").addEventListener("click",tb);document.getElementById("about").addEventListener("click",()=>{const a=document.createElement("div");a.classList.add("popupInner","about");const b=document.createElement("div");let c=null;const d=document.createElement("div");d.classList.add("logo");b.appendChild(d);b.classList.add("logoWrapper");var e=document.createElement("div"),m=document.createElement("div"),n=document.createElement("div");e.classList.add("wall");m.classList.add("wall");n.classList.add("wall");var k=document.createElement("div");
for(var g=0;g<16;++g){var l=document.createElement("div");l.style.setProperty("--i",g.toString());k.appendChild(l)}k.classList.add("line");d.append(e,m,n,k);let u,p;b.addEventListener("pointermove",da=>{da.target===da.currentTarget&&(clearTimeout(u),c=c??b.getBoundingClientRect(),d.style.setProperty("--dy",`${(da.clientX-c.left-c.width/2)/5}deg`),d.style.setProperty("--dx",`${(c.height/2-(da.clientY-c.top))/5}deg`),p==null&&(d.classList.add("quick"),p=setTimeout(()=>{d.classList.add("no-transition");
d.classList.remove("quick")},200)))});b.addEventListener("pointerleave",()=>{clearTimeout(p);p=null;u=setTimeout(()=>{d.classList.remove("quick");d.classList.remove("no-transition");d.style.removeProperty("--dx");d.style.removeProperty("--dy")},100)});e=document.createElement("div");e.classList.add("popupInner");m=document.createElement("h2");m.textContent="UsyTrace";n=document.createElement("h3");n.textContent="made with \u2764\ufe0f by usy";k=document.createElement("h6");k.textContent="i made the 3d icon while procrastinating studying for exams, try hovering over it or dragging it";
g=document.createElement("div");g.textContent="Find me at:";l=document.createElement("div");l.textContent="Discord: @usy_";const B=document.createElement("div");var q=document.createElement("a");B.textContent="Email: ";q.href="mailto:usy@usyless.uk";q.textContent="usy@usyless.uk";B.appendChild(q);q=document.createElement("div");const P=document.createElement("a");q.textContent="GitHub: ";P.href="https://github.com/usyless/UsyTrace/issues";P.textContent="usyless";q.appendChild(P);e.append(m,n,g,l,
B,q,k);a.append(b,e);h(a,{A:[{target:window,type:"resize",listener:()=>{c=b.getBoundingClientRect()}}]})});"serviceWorker"in navigator&&!["localhost","127.0.0.1"].includes(location.hostname)&&(navigator.serviceWorker.addEventListener("controllerchange",()=>{window.location.reload()}),navigator.serviceWorker.register("./service-worker.js").then(a=>{if(a.waiting&&navigator.serviceWorker.controller){const b=document.getElementById("updateAvailable"),c=a.waiting;b.addEventListener("click",()=>{c.postMessage({action:"skipWaiting"})});b.classList.remove("hidden")}a.addEventListener("updatefound",()=>{const b=
a.installing;b.addEventListener("statechange",()=>{if(b.state==="installed"&&navigator.serviceWorker.controller){const c=document.getElementById("updateAvailable");c.addEventListener("click",()=>{b.postMessage({action:"skipWaiting"})});c.classList.remove("hidden")}})})}));const vb={default:"\u27a1\ufe0f\ud83d\udcbb Follow system",dark:"\ud83c\udf11 Default dark",light:"\u2600\ufe0f Default light","solarized-dark":"\ud83d\udfe6 Solarized dark","solarized-light":"\ud83c\udf68 Solarized light"},wb=()=>{for(const a of document.documentElement.classList)if(a.startsWith("theme-"))return a.replaceAll("theme-","")};let xb;
const yb=a=>{for(const b of Array.from(document.documentElement.classList))b.startsWith("theme-")&&document.documentElement.classList.remove(b);clearTimeout(xb);document.documentElement.classList.add("transition-theme");xb=setTimeout(()=>{document.documentElement.classList.remove("transition-theme")},200);a==="default"?window.localStorage.removeItem("theme"):window.localStorage.setItem("theme",a);window.dispatchEvent(new CustomEvent("themeChange"))},zb=document.getElementById("themeSwitch");
zb.addEventListener("click",()=>{const a=document.createElement("div");var b=document.createElement("h3");a.classList.add("themePopupInner");b.textContent="Theme";a.appendChild(b);for(var c in vb)b=document.createElement("button"),b.classList.add("standardButton"),b.textContent=vb[c],b.dataset.theme=c,a.appendChild(b);if(c=a.querySelector(`[data-theme="${wb()}"]`))c.classList.add("active"),c.textContent+=" - current";a.addEventListener("click",d=>{if(d=d.target.closest("[data-theme]")?.dataset?.theme)yb(d),
r()});h(a,{buttons:"Exit",v:["themePopup"],F:d=>{d.classList.remove("blur");const {bottom:e,right:m}=zb.getBoundingClientRect();d.firstElementChild.style.setProperty("--yOffset",`${window.innerHeight-e}px`);d.firstElementChild.style.setProperty("--xOffset",`${window.innerWidth-m}px`)}})});
