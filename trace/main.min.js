var ba=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};function ca(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");}var da=ca(this);
function ea(a,b){if(b)a:{var c=da;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))break a;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&b!=null&&ba(c,a,{configurable:!0,writable:!0,value:b})}}
ea("String.prototype.replaceAll",function(a){return a?a:function(b,c){if(b instanceof RegExp&&!b.global)throw new TypeError("String.prototype.replaceAll called with a non-global RegExp argument.");return b instanceof RegExp?this.replace(b,c):this.replace(new RegExp(String(b).replace(/([-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1").replace(/\x08/g,"\\x08"),"g"),c)}});var f=!0;const fa=[],ha=[];let ia;
async function h(a,{v:b=[],buttons:c,u:d=[],onclose:e,D:l,B:n}={}){n||t();f=!1;return new Promise(k=>{const g=document.createElement("div"),m=document.createElement("div"),q=document.createElement("div");g.setAttribute("usy-overlay","");g.classList.add("fullscreen","blur");m.classList.add("popupOuter",...d);q.classList.add("popupInner",...d);const v=[];if(typeof a==="string"){var r=document.createElement("div");r.classList.add("popupText");r.textContent=a;v.push(r)}else Array.isArray(a)?v.push(...a):
v.push(a);m.appendChild(q);if(typeof c==="string"||c==null){r=document.createElement("div");r.classList.add("popupButtons");const p=document.createElement("button");p.classList.add("standardButton");p.textContent=c??"Ok";r.appendChild(p);p.addEventListener("click",()=>{const N=a.C?.();n?t(null,g):t();k(N??!0)});ia=p}else r=c;q.append(...v,r);g.addEventListener("click",p=>{p.target===p.currentTarget&&(n?t(null,g):t(),k(!1))});g.appendChild(m);b.push({target:window,type:"keydown",listener:p=>{p.key.toLowerCase()===
"escape"&&g.click()}});for(const p of b)fa.push(p),p.target.addEventListener(p.type,p.listener);e!=null&&ha.push(e);l?.(g);document.body.appendChild(g)})}function t(a,b=null){if(b)b.remove();else{f=!0;for(const c of fa)c.target?.removeEventListener?.(c.type,c.listener);for(const c of ha)c();ha.length=0;fa.length=0;document.querySelectorAll("[usy-overlay]").forEach(c=>c.remove())}};const u={FRHigher:2E4,FRLower:20,colourTolerance:67,line_move_speed:100,PPO:48,delimitation:"tab",lowFRExport:20,highFRExport:2E4,SPLHigher:"",SPLLower:""};document.getElementById("restoreDefault").addEventListener("click",()=>{ja();h("Restored settings to default")});function ja(){for(const a in u)document.getElementById(a).value=u[a]}let w,x,y,ka,z=null,A=null;const B=document.getElementById("glass");B.l=B.querySelector("img");B.H=a=>{B.style.borderColor=`rgb(${a})`};
B.A=()=>{C.m()&&(B.l.src=C.src,B.l.width=C.clientWidth*3,B.l.height=C.clientHeight*3)};
var la=()=>{document.querySelector('.waiting-overlay[data-for="trace"]').classList.remove("enabled")},D=document.getElementById("lines"),E={xHigh:document.getElementById("xHigh"),xLow:document.getElementById("xLow"),yHigh:document.getElementById("yHigh"),yLow:document.getElementById("yLow")},ma=(a,b)=>{const c=a.dataset.direction;a.nextElementSibling.setAttribute(c,b);a.setAttribute(`${c}1`,b);a.setAttribute(`${c}2`,b)},na=()=>{for(const a of D.querySelectorAll("line"))a.setAttribute("stroke-width",
w);for(const a of D.querySelectorAll("text"))a.setAttribute("font-size",`${1.3*w}em`)},F=a=>parseFloat(a.getAttribute(`${a.dataset.direction}1`)),G=(a,b)=>{const c=F(E[a.dataset.other]),d=a.dataset.direction==="x"?x:y;a===E.xHigh||a===E.yLow?ma(a,Math.max(c+1,Math.min(d-1,b))):ma(a,Math.max(1,Math.min(c-1,b)))},H=()=>D.classList.remove("hidden"),I=()=>D.classList.add("hidden"),oa=()=>{for(const a of J){const [b,c]=a.dataset.direction==="x"?["y",y]:["x",x];a.setAttribute(`${b}1`,"0");a.setAttribute(`${b}2`,
c)}E.xHigh.nextElementSibling.setAttribute("y",(y/2).toString());E.xLow.nextElementSibling.setAttribute("y",(y/2).toString());E.yHigh.nextElementSibling.setAttribute("x",(x/2).toString());E.yLow.nextElementSibling.setAttribute("x",(x/2).toString())},J=[E.xHigh,E.xLow,E.yHigh,E.yLow],qa=()=>{pa.classList.remove("hidden");K.setAttributeNS(null,"width","0")},ra=()=>{document.getElementById("erasing").classList.add("hidden")},pa,K,L;pa=document.getElementById("erasing");K=pa.firstElementChild;
const C=document.getElementById("uploadedImage");C.i=a=>{const b=C.getBoundingClientRect(),c=a.clientX;a=a.clientY;return{x:c,y:a,xRel:c-b.left,yRel:a-b.top}};C.m=()=>C.src.startsWith("blob:");C.G=()=>{const a=M.get(C.src),b={};if(a){for(const c in E)b[c]=F(E[c]);a.lines=b}};C.F=()=>{const a=M.get(C.src).lines;for(const b in E)G(E[b],a[b]);oa();H()};
const O=(()=>{const a=document.getElementById("SPLHigher"),b=document.getElementById("SPLLower"),c=document.getElementById("FRHigher"),d=document.getElementById("FRLower"),e=document.getElementById("snapToLines"),l=document.getElementById("line_move_speed"),n=document.getElementById("colourTolerance"),k=document.getElementById("PPO"),g=document.getElementById("delimitation"),m=document.getElementById("lowFRExport"),q=document.getElementById("highFRExport");return{SPLHigher:()=>a.value,SPLLower:()=>
b.value,FRHigher:()=>c.value,FRLower:()=>d.value,snapToLines:()=>e.checked,line_move_speed:()=>parseInt(l.value,10)||u.line_move_speed,colourTolerance:()=>parseInt(n.value,10)||u.colourTolerance,PPO:()=>k.value||u.PPO,delimitation:()=>g.value||u.delimitation,lowFRExport:()=>m.value||u.lowFRExport,highFRExport:()=>q.value||u.highFRExport}})(),sa=a=>{h(a).then(()=>sa(a)).catch(()=>sa(a))};
var ta=()=>{for(const a of document.querySelectorAll("#sidebar [data-default]"))a.textContent=a.dataset["default"];z=null;A?.()},ua=a=>{document.getElementById("undo").disabled=!a.undo;document.getElementById("redo").disabled=!a.redo};
const va=["selectPath","selectPoint","eraseRegion"],wa={path:I,point:I,erase:()=>{I();qa()}},xa={path:H,point:H,erase:()=>{ra();H()}},ya=a=>{a=a.target;const b=a.dataset.mode,c=JSON.parse(JSON.stringify(z));ta();c===b?(A?.(),z=null):(a.textContent=a.dataset.active,A?.(),A=xa[b],z=b,wa[b]())};for(const a of va)document.getElementById(a).addEventListener("click",ya);
var Aa=(()=>{const a=new Worker("./usytrace.js",{type:"module"});a.onmessage=b=>{b=b.data;var c=b.type;switch(c){case "exportTrace":c=document.createElement("div");const d=document.createElement("div"),e=document.createElement("input");d.textContent="Export file name";e.placeholder="trace";e.type="text";e.classList.add("sidebarSection");c.append(d,e);c.classList.add("exportBox");c.C=()=>e.value;h(c,{buttons:"Save Trace",v:[{target:document,type:"keydown",listener:l=>{l.key.toLowerCase()==="enter"&&
ia.click()}}]}).then(l=>{if(l!==!1){const n=document.createElement("a"),k=URL.createObjectURL(new Blob([b["export"]],{type:"text/plain;charset=utf-8"}));n.href=k;n.classList.add("hidden");document.body.appendChild(n);!l?.endsWith(".txt")&&l?.length>0&&(l+=".txt");n.download=l||"trace.txt";n.click();setTimeout(()=>{URL.revokeObjectURL(k);document.body.removeChild(n)},5E3)}});setTimeout(()=>{e.focus()},50);break;case "error":la();sa(b.message);break;case "getHistoryStatus":ua(b);break;case "setData":console.timeEnd("Initialise image");
break;default:C.src===b.src&&(c==="getPixelColour"?B.H(b.pixelColour):c==="snapLine"?(G(E[b.line.name],b.line.position),b["final"]&&(F(E.xHigh)<x*.2&&G(E.xHigh,x),F(E.xLow)>x*.8&&G(E.xLow,0),F(E.yHigh)>y*.8&&G(E.yHigh,0),F(E.yLow)<y*.2&&G(E.yLow,y))):(za(b.svg),la(),P({type:"getHistoryStatus"})))}};return a})(),P=a=>C.m()&&Aa.postMessage({src:C.src,...a}),Ba=(a,b)=>{P({type:"eraseRegion",begin:a,end:b})},Ca=()=>{P({type:"autoTrace",colourTolerance:O.colourTolerance()})},Q=(a,b,c=!1)=>{P({type:"snapLine",
line:{name:a.id,position:F(a),direction:a.dataset.direction},direction:b,final:c})},za=a=>{var b=document.getElementById("trace");const c=b.lastElementChild;b=b.firstElementChild;c.setAttribute("d",a);c.setAttribute("stroke","#ff0000");c.setAttribute("stroke-width",ka);b.setAttribute("d",a);b.setAttribute("stroke-width",(ka*1.5).toString())};document.getElementById("autoPath").addEventListener("click",Ca);document.getElementById("undo").addEventListener("click",()=>P({type:"undoTrace"}));
document.getElementById("redo").addEventListener("click",()=>P({type:"redoTrace"}));document.getElementById("clearPath").addEventListener("click",()=>P({type:"clearTrace"}));
document.getElementById("export").addEventListener("click",()=>{const a=c=>Object.values(c).some(d=>d&&typeof d==="object"?a(d):d==null||d===""),b={type:"exportTrace",PPO:O.PPO(),delim:O.delimitation(),lowFR:O.lowFRExport(),highFR:O.highFRExport(),SPL:{top:O.SPLHigher(),topPixel:F(E.yHigh),bottom:O.SPLLower(),bottomPixel:F(E.yLow)},FR:{top:O.FRHigher(),topPixel:F(E.xHigh),bottom:O.FRLower(),bottomPixel:F(E.xLow)}};a(b)?h("Please fill in all required values to export (SPL and FR values)"):P(b)});
document.getElementById("smoothTrace").addEventListener("click",()=>P({type:"smoothTrace"}));const M=new Map,R=document.getElementById("fileInput");
var Da=document.getElementById("imageQueueInner"),Ea=a=>{M.delete(a.src);P({type:"removeImage",src:a.src});URL.revokeObjectURL(a.src);a.remove()},Fa=()=>{Da.querySelector('img[class="selectedImage"]').scrollIntoView({inline:"center",behavior:"smooth"})},Ha=(a,b=!1)=>{const c=document.createElement("img"),d=document.getElementById("imageQueueInner");c.src=a;M.set(c.src,{initial:!0});c.addEventListener("dragstart",e=>e.preventDefault());c.addEventListener("click",e=>{e.preventDefault();e.stopPropagation();
C.G();C.src=a;for(const l of Da.querySelectorAll('img[class="selectedImage"]'))l.classList.remove("selectedImage");c.classList.add("selectedImage");Fa()});c.addEventListener("contextmenu",e=>{e.preventDefault();c.classList.contains("selectedImage")&&(e=c.nextElementSibling,e||(e=c.previousElementSibling),e?e.click():Ga());Ea(c)});d.appendChild(c);b&&(c.click(),setTimeout(()=>Fa(),50))};document.getElementById("removeImage").addEventListener("click",()=>document.querySelector('img[class="selectedImage"]')?.dispatchEvent(new Event("contextmenu")));
document.getElementById("toggleImageQueue").addEventListener("click",a=>{a=a.target;document.getElementById("imageContainer").addEventListener("transitionend",()=>window.dispatchEvent(new Event("resize")),{once:!0});a.textContent===a.dataset.active?(a.textContent=a.dataset["default"],a.removeAttribute("active")):(a.textContent=a.dataset.active,a.setAttribute("active",""))});
document.getElementById("editImage").addEventListener("click",()=>{if(C.m()){const d=document.createElement("div");var a=document.createElement("h3"),b=document.createElement("div"),c=document.createElement("div");const e=document.createElement("img");d.id="editContainer";d.append(a,b,c);c.append(e);c.classList.add("cropWrapper");e.draggable=!1;a.textContent="Edit Image";e.src=C.src;const l=new Set,n=!("filter"in CanvasRenderingContext2D.prototype);a=n?{Invert:"invert(1)"}:{Invert:{g:"invert",default:1,
unit:""},Brightness:{g:"brightness",default:120,unit:"%",description:"Enter value for brightness in %",validate:k=>Math.max(0,k)},Contrast:{g:"contrast",default:120,unit:"%",description:"Enter value for contrast in %",validate:k=>Math.max(0,k)},Saturate:{g:"saturate",default:120,unit:"%",description:"Enter value for saturation in %",validate:k=>Math.max(0,k)},Hue:{g:"hue-rotate",default:5,unit:"deg",description:"Enter value for hue rotation in degrees",validate:k=>Math.abs(k)%360}};for(const k in a){c=
document.createElement("button");c.textContent=k;c.classList.add("standardButton");b.appendChild(c);const g=a[k];c.addEventListener("click",()=>{if(l.has(k))l.delete(k),e.style.filter=e.style.filter.replaceAll(new RegExp(`${g.g}\\(.*\\)`,"g"),"");else if(g.validate){const m=document.createElement("input");m.placeholder=g.default;m.type="number";const q=[document.createTextNode(g.description),m];q.C=()=>m.value||g.default;h(q,{B:!0}).then(v=>{v!==!1&&Number.isFinite(Number(v))?(v=g.validate(v),l.add(k),
e.style.filter+=`${g.g}(${v}${g.unit})`):h("Invalid value.",{B:!0})})}else l.add(k),e.style.filter+=`${g.g}(${g.default}${g.unit})`})}b=document.createElement("div");b.classList.add("popupButtons");a=document.createElement("button");c=document.createElement("button");a.classList.add("standardButton");a.textContent="Cancel";c.classList.add("standardButton");c.textContent="Save";b.append(a,c);a.addEventListener("click",t);c.addEventListener("click",()=>{const k=document.createElement("canvas"),g=k.getContext("2d");
k.width=x;k.height=y;n||(g.filter=e.style.filter);g.drawImage(e,0,0);if(n){console.log("Using fallback invert mode");const m=g.getImageData(0,0,x,y),q=m.data,v=q.length;for(let r=0;r<v;r+=4)q[r]=255-q[r],q[r+1]=255-q[r+1],q[r+2]=255-q[r+2];g.putImageData(m,0,0)}document.getElementById("removeImage").click();k.toBlob(m=>{Ha(URL.createObjectURL(m),!0);t()})},{once:!0});h(d,{buttons:b})}else h("No valid image selected")});ja();Ga();
R.o=a=>{a=Array.from(a).filter(c=>c.type.startsWith("image/"));const b=a.length-1;a.length>0?(t(),a.forEach((c,d)=>{c=URL.createObjectURL(c);Ha(c,d===b)})):h("Invalid image/file(s) added!");R.value=""};R.addEventListener("change",a=>{R.o(a.target.files)});C.addEventListener("dragstart",a=>a.preventDefault());document.getElementById("fileInputButton").addEventListener("click",()=>R.click());
document.addEventListener("paste",a=>{a.preventDefault();const b=new DataTransfer;for(const c of a.clipboardData.items)c.kind==="file"&&b.items.add(c.getAsFile());b.files.length>0&&R.o(b.files)});S("dragover",document.body,a=>{a.preventDefault();a.dataTransfer.dropEffect="copy";document.body.classList.add("lowOpacity")});S(["dragleave","dragend"],document.body,a=>{a.preventDefault();document.body.classList.remove("lowOpacity")});
S("drop",document.body,a=>{a.preventDefault();document.body.classList.remove("lowOpacity");R.o(a.dataTransfer.files)});
C.addEventListener("pointermove",a=>{if(z!=="erase"){a.preventDefault();const b=C.parentElement,c=b.getBoundingClientRect();a=C.i(a);B.style.left=`${Math.min(a.x-c.left,b.clientWidth-B.clientWidth)}px`;B.style.top=`${Math.min(a.y-c.top,b.clientHeight-B.clientHeight)}px`;B.l.style.left=`${(a.xRel*3-B.clientWidth/2)*-1}px`;B.l.style.top=`${(a.yRel*3-B.clientHeight/2)*-1}px`;P({type:"getPixelColour",x:a.xRel*w,y:a.yRel*w});B.classList.remove("hidden")}});
S(["pointerleave","pointerout","pointercancel"],C,()=>B.classList.add("hidden"));let T=null,Ia=C.i;D.addEventListener("pointerdown",a=>{const b=Ia(a);a={x:x*.02,y:y*.02};for(var c of J)c.offset=b[`${c.dataset.direction}Rel`]*w-F(c);c=J.reduce((d,e)=>Math.abs(e.offset)<Math.abs(d.offset)?e:d,J[0]);Math.abs(c.offset)<a[c.dataset.direction]&&(T=c)});D.addEventListener("pointermove",a=>{T&&G(T,Ia(a)[`${T.dataset.direction}Rel`]*w-T.offset)});
S(["pointerup","pointerleave","pointercancel"],D,a=>{a.preventDefault();T=null});let U,Ja,Ka=O.snapToLines();document.getElementById("snapToLines").addEventListener("change",()=>Ka=O.snapToLines());
document.getElementById("buttonSection").addEventListener("pointerdown",a=>{const b=a.target,c=b.parentNode;if(!U&&c.classList.contains("moveButtons"))if(a.preventDefault(),a=c.dataset["for"])if(Ja=E[a],Ka)Q(E[c.dataset["for"]],parseInt(b.dataset.direction,10));else{const d=parseInt(b.dataset.direction,10);U=setInterval(()=>{G(Ja,F(Ja)+d*w)},100/O.line_move_speed()*10)}else{const d=parseInt(b.dataset.direction,10);U=setInterval(()=>{P({type:"offsetTrace",direction:d,magnitude:w})},100/O.line_move_speed()*
10)}});S(["pointerup","pointerleave","pointerout","pointercancel"],document.getElementById("buttonSection"),a=>{a.preventDefault();clearInterval(U);U=null});window.addEventListener("resize",()=>{w=x/C.clientWidth;na();B.A()});const La={path:(a,b)=>{P({type:"trace",x:a,y:b,colourTolerance:O.colourTolerance()})},point:(a,b)=>P({type:"addPoint",x:a,y:b})};C.addEventListener("pointerup",a=>{z!=null&&(a=C.i(a),La[z]?.(a.xRel*w,a.yRel*w))});let V=!1;
C.addEventListener("pointerdown",a=>{z==="erase"&&(a.preventDefault(),V=!0,a=C.i(a).xRel*w,qa(),L=Math.max(Math.min(+a,x),0),K.setAttributeNS(null,"x",a),document.addEventListener("pointerup",Ma,{once:!0}))});C.addEventListener("pointermove",a=>{V&&z==="erase"&&(a.preventDefault(),a=C.i(a).xRel*w,a=+a,a<L?(K.setAttributeNS(null,"width",`${L-a}px`),K.setAttributeNS(null,"x",a)):(K.setAttributeNS(null,"width",`${a-L}px`),K.setAttributeNS(null,"x",L.toString())))});
const Ma=a=>{V&&z==="erase"&&(a.preventDefault(),V=!1,a=C.i(a).xRel*w,a=Math.max(Math.min(+a,x),0),Ba(...(L<a?[L,a]:[a,L])),K.setAttributeNS(null,"width","0"))};
C.addEventListener("load",()=>{document.getElementById("defaultMainText").classList.add("hidden");for(var a of document.querySelectorAll("[data-disabled]"))a.disabled=!1;ta();x=C.naturalWidth;y=C.naturalHeight;ka=Math.max(x,y)*.003;w=x/C.clientWidth;ra();for(var b of document.querySelectorAll("svg"))b.setAttribute("width",x),b.setAttribute("height",y),b.setAttribute("viewBox",`0 0 ${x} ${y}`);za("");B.A();a=M.get(C.src);if(a.initial){document.querySelector('.waiting-overlay[data-for="trace"]').classList.add("enabled");
console.time("Initialise image");b=x;var c=y,d=document.createElement("canvas");const e=d.getContext("2d");d.width=b;d.height=c;e.drawImage(C,0,0);d=e.getImageData(0,0,b,c);Aa.postMessage({src:C.src,type:"setData",data:d.data,width:b,height:c},[d.data.buffer]);G(E.xHigh,x);G(E.xLow,0);G(E.yHigh,0);G(E.yLow,y);oa();H();Q(E.xHigh,-1);Q(E.xLow,1);Q(E.yHigh,1);Q(E.yLow,-1,!0);Ca();a.initial=!1}else P({type:"setCurrent"}),C.F(),P({type:"getCurrentPath"});na()});
C.addEventListener("error",()=>{if(C.m()){for(const a of Da.querySelectorAll('img[class="selectedImage"]'))Ea(a);h("Error loading this image, it may be malformed")}});
const W=new PointerEvent("pointerdown",{bubbles:!0}),X=new PointerEvent("pointerup",{bubbles:!0}),Na=document.getElementById("redo"),Oa=document.getElementById("undo"),Pa=document.getElementById("autoPath"),Qa=document.getElementById("selectPath"),Ra=document.getElementById("selectPoint"),Sa=document.getElementById("toggleImageQueue"),Ta=document.getElementById("export"),Ua=document.getElementById("smoothTrace"),Va=document.getElementById("editImage"),Wa=document.getElementById("eraseRegion"),Xa=
document.getElementById("fileInputButton"),Ya=document.getElementById("removeImage"),Za=document.getElementById("clearPath"),$a=document.querySelector('[data-id="offset_trace"] > [data-direction="1"]'),ab=document.querySelector('[data-id="offset_trace"] > [data-direction="0"]'),bb=document.querySelector('[data-id="offset_trace"] > [data-direction="2"]'),cb=document.querySelector('[data-id="offset_trace"] > [data-direction="3"]'),db=document.querySelector('[data-for="yLow"] > [data-direction="-1"]'),
eb=document.querySelector('[data-for="yLow"] > [data-direction="1"]'),fb=document.querySelector('[data-for="xLow"] > [data-direction="-1"]'),gb=document.querySelector('[data-for="xLow"] > [data-direction="1"]'),hb=document.querySelector('[data-for="yHigh"] > [data-direction="-1"]'),ib=document.querySelector('[data-for="yHigh"] > [data-direction="1"]'),jb=document.querySelector('[data-for="xHigh"] > [data-direction="-1"]'),kb=document.querySelector('[data-for="xHigh"] > [data-direction="1"]'),lb={z:a=>
a.ctrlKey&&(a.shiftKey?Na:Oa).click(),a:()=>Pa.click(),t:()=>Qa.click(),p:()=>Ra.click(),h:()=>Sa.click(),s:a=>(a.ctrlKey?Ta:Ua).click(),e:a=>(a.ctrlKey?Va:Wa).click(),enter:()=>Xa.click(),delete:()=>Ya.click(),backspace:()=>Za.click(),arrowup:a=>(a.ctrlKey?$a:a.shiftKey?db:hb).dispatchEvent(W),arrowdown:a=>(a.ctrlKey?ab:a.shiftKey?eb:ib).dispatchEvent(W),arrowleft:a=>(a.ctrlKey?bb:a.shiftKey?fb:jb).dispatchEvent(W),arrowright:a=>(a.ctrlKey?cb:a.shiftKey?gb:kb).dispatchEvent(W)},mb={arrowup:a=>(a.ctrlKey?
$a:a.shiftKey?db:hb).dispatchEvent(X),arrowdown:a=>(a.ctrlKey?ab:a.shiftKey?eb:ib).dispatchEvent(X),arrowleft:a=>(a.ctrlKey?bb:a.shiftKey?fb:jb).dispatchEvent(X),arrowright:a=>(a.ctrlKey?cb:a.shiftKey?gb:kb).dispatchEvent(X)};document.addEventListener("keydown",a=>{if(f){const b=lb[a.key.toLowerCase()];!a.target.closest("input")&&b&&(a.preventDefault(),b(a))}});document.addEventListener("keyup",a=>{if(f){const b=mb[a.key.toLowerCase()];!a.target.closest("input")&&b&&(a.preventDefault(),b(a))}});
function S(a,b,c){for(const d of Array.isArray(a)?a:[a])b.addEventListener(d,c)}function Ga(){document.getElementById("defaultMainText").classList.remove("hidden");for(const a of document.querySelectorAll("[data-disabled]"))a.disabled=!0;ta();I();ra();za("");C.src=""}const nb=a=>{a=a.target;parseInt(a.value,10)<a.min&&(a.value=a.min)},ob=a=>{a=a.target;parseInt(a.value,10)>a.max&&(a.value=a.max)};
for(const a of["FRLower","colourTolerance","lowFRExport","line_move_speed"])document.getElementById(a).addEventListener("change",nb);for(const a of["line_move_speed"])document.getElementById(a).addEventListener("change",ob);const Y=[{j:"Welcome to UsyTrace",body:"<h2>Here you can trace frequency responses from images</h2>\n\nAll you need to know, as well as keybindings are on the next few pages"},{j:"Tracing",body:"<h3>Auto Trace (a)</h3>\nTries to automatically select a line in the image, may fail, applied automatically upon image import\n    \n<h3>Select Path (t)</h3>\nTraces to the right of the point you click on the image, can complete a trace by starting from the left side of the frequency response and clicking to the right if it misses a part\n\n<h3>Add Point (p)</h3>\nAdd a single point to the trace manually, useful for situations where Select Path or Auto Trace Fails\n\n<h3>Smooth Trace (s)</h3>\nSmooths out sudden bumps in the traced line, good for if the original image is bad and the traced line is inconsistent\n\n<h3>Undo (Ctrl + z)</h3>\nGoes back to the previous trace step, saves add point, tracing, and clearing history\n\n<h3>Redo (Ctrl + Shift + z)</h3>\nGoes back to recently undone trace steps\n\n<h3>Erase Region (e)</h3>\nSelect a region to erase a trace from by dragging a box around the area\n\n<h3>Clear Path (Backspace)</h3>\nClears the current trace on screen, can go back using Undo"},
{j:"Exporting",body:"Align <b>High</b> and <b>Low</b> lines with given values in their respective axis, then input the respective values into <b>Higher SPL</b>, <b>Lower SPL</b>, <b>Higher Frequency</b> and <b>Lower Frequency</b>.\n\nThe lines can be moved with the arrow keys, defaulting to the <b>High</b> line for each axis, but can control the <b>Low</b> line by holding <b>Shift</b>\n\n<h3>Trace Settings</h3>     \nAdjust the <b>Minimum Exported Frequency</b>, <b>Maximum Exported Frequency</b>, <b>Points Per Octave of the exported data</b>, and <b>the delimitation of the exported data</b>\n\nThen <b>Export Trace</b> will give you the result"},
{j:"Settings",body:"<h3>Buttons Snap To Axis</h3>\nwhether the buttons underneath the Export values will attempt to snap the lines to their axis, or to enable smooth manual movement\n    \n<h3>Colour Tolerance</h3>\nRaise if line is not being detected, Lower if line is jagged or detecting multiple lines"},{j:"Miscellaneous",body:"You can <b>drop</b>, or <b>choose any amount of images</b> you like into the site, other than with pasting, as that only supports one image at a time.\n\n<h3>Image Editing (Ctrl + e)</h3>\nHere you can apply filters to the image that may make it trace better.\n\n<h3>Image Queue</h3>\nLoaded images show in the image queue on the bottom, and can be removed by right-clicking them (long hold on mobile), pressing <b>Remove</b> or pressing the <b>Delete</b> key on your keyboard"}];
let Z=0;var pb;try{pb=parseInt(window.localStorage.getItem("USER_TUTORIAL_VERSION")??0,10)}catch{pb=0}3!==pb&&qb();
function qb(){function a(){Z>=Y.length-1?g.textContent="End Tutorial":Z<=0?(g.textContent="Begin Tutorial",m.disabled=!0,m.textContent=""):(g.textContent="Next",m.disabled=!1,m.textContent="Previous");b()}function b(){const q=Y[Z]??Y[0];l.textContent=q.j;k.innerHTML=q.body}Z=0;const c=document.createElement("div"),d=document.createElement("div");d.classList.add("popupButtons");c.classList.add("popupText");const e=document.createElement("div"),l=document.createElement("h1"),n=document.createElement("button");
e.classList.add("headContainer");n.classList.add("standardButton");n.textContent="\ud800\udf22";n.addEventListener("click",t);e.append(l,n);const k=document.createElement("p");c.append(k);const g=document.createElement("button"),m=document.createElement("button");g.classList.add("standardButton");m.classList.add("standardButton");g.addEventListener("click",()=>{Z>=Y.length-1&&n.click();++Z;a()});m.addEventListener("click",()=>{--Z;a()});a();b();d.append(m,g);h([e,c,d],{buttons:d,u:["fixedSize"],onclose:rb})}
function rb(){window.localStorage.setItem("USER_TUTORIAL_VERSION",(3).toString())}document.getElementById("tutorial").addEventListener("click",qb);document.getElementById("about").addEventListener("click",()=>{const a=document.createElement("div");a.classList.add("popupInner","about");const b=document.createElement("div");let c=null;const d=document.createElement("div");d.classList.add("logo");b.appendChild(d);b.classList.add("logoWrapper");var e=document.createElement("div"),l=document.createElement("div"),n=document.createElement("div");e.classList.add("wall");l.classList.add("wall");n.classList.add("wall");var k=document.createElement("div");
for(var g=0;g<16;++g){var m=document.createElement("div");m.style.setProperty("--i",g.toString());k.appendChild(m)}k.classList.add("line");d.append(e,l,n,k);let q,v;b.addEventListener("pointermove",aa=>{aa.target===aa.currentTarget&&(clearTimeout(q),c=c??b.getBoundingClientRect(),d.style.setProperty("--dy",`${(aa.clientX-c.left-c.width/2)/5}deg`),d.style.setProperty("--dx",`${(c.height/2-(aa.clientY-c.top))/5}deg`),v==null&&(d.classList.add("quick"),v=setTimeout(()=>{d.classList.add("no-transition");
d.classList.remove("quick")},200)))});b.addEventListener("pointerleave",()=>{clearTimeout(v);v=null;q=setTimeout(()=>{d.classList.remove("quick");d.classList.remove("no-transition");d.style.removeProperty("--dx");d.style.removeProperty("--dy")},100)});e=document.createElement("div");e.classList.add("popupInner");l=document.createElement("h2");l.textContent="UsyTrace";n=document.createElement("h3");n.textContent="made with \u2764\ufe0f by usy";k=document.createElement("h6");k.textContent="i made the 3d icon while procrastinating studying for exams, try hovering over it or dragging it";
g=document.createElement("div");g.textContent="Find me at:";m=document.createElement("div");m.textContent="Discord: @usy_";const r=document.createElement("div");var p=document.createElement("a");r.textContent="Email: ";p.href="mailto:usy@usyless.uk";p.textContent="usy@usyless.uk";r.appendChild(p);p=document.createElement("div");const N=document.createElement("a");p.textContent="GitHub: ";N.href="https://github.com/usyless/UsyTrace/issues";N.textContent="usyless";p.appendChild(N);e.append(l,n,g,m,
r,p,k);a.append(b,e);h(a,{v:[{target:window,type:"resize",listener:()=>{c=b.getBoundingClientRect()}}]})});"serviceWorker"in navigator&&!["localhost","127.0.0.1"].includes(location.hostname)&&(navigator.serviceWorker.addEventListener("controllerchange",()=>{window.location.reload()}),navigator.serviceWorker.register("./service-worker.js").then(a=>{if(a.waiting&&navigator.serviceWorker.controller){const b=document.getElementById("updateAvailable"),c=a.waiting;b.addEventListener("click",()=>{c.postMessage({action:"skipWaiting"})});b.classList.remove("hidden")}a.addEventListener("updatefound",()=>{const b=
a.installing;b.addEventListener("statechange",()=>{if(b.state==="installed"&&navigator.serviceWorker.controller){const c=document.getElementById("updateAvailable");c.addEventListener("click",()=>{b.postMessage({action:"skipWaiting"})});c.classList.remove("hidden")}})})}));const sb={default:"\u27a1\ufe0f\ud83d\udcbb Follow system",dark:"\ud83c\udf11 Default dark",light:"\u2600\ufe0f Default light","solarized-dark":"\ud83d\udfe6 Solarized dark","solarized-light":"\ud83c\udf68 Solarized light"},tb=()=>{for(const a of document.documentElement.classList)if(a.startsWith("theme-"))return a.replaceAll("theme-","")};let ub;
const vb=a=>{for(const b of Array.from(document.documentElement.classList))b.startsWith("theme-")&&document.documentElement.classList.remove(b);clearTimeout(ub);document.documentElement.classList.add("transition-theme");ub=setTimeout(()=>{document.documentElement.classList.remove("transition-theme")},200);a==="default"?window.localStorage.removeItem("theme"):window.localStorage.setItem("theme",a);window.dispatchEvent(new CustomEvent("themeChange"))},wb=document.getElementById("themeSwitch");
wb.addEventListener("click",()=>{const a=document.createElement("div");var b=document.createElement("h3");a.classList.add("themePopupInner");b.textContent="Theme";a.appendChild(b);for(var c in sb)b=document.createElement("button"),b.classList.add("standardButton"),b.textContent=sb[c],b.dataset.theme=c,a.appendChild(b);if(c=a.querySelector(`[data-theme="${tb()}"]`))c.classList.add("active"),c.textContent+=" - current";a.addEventListener("click",d=>{if(d=d.target.closest("[data-theme]")?.dataset?.theme)vb(d),
t()});h(a,{buttons:"Exit",u:["themePopup"],D:d=>{d.classList.remove("blur");const {bottom:e,right:l}=wb.getBoundingClientRect();d.firstElementChild.style.setProperty("--yOffset",`${window.innerHeight-e}px`);d.firstElementChild.style.setProperty("--xOffset",`${window.innerWidth-l}px`)}})});
