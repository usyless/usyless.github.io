var b;b||=typeof Module != 'undefined' ? Module : {};var e={...b},h="",k,l;h=self.location.href;h=h.startsWith("blob:")?"":h.slice(0,h.replace(/[?#].*/,"").lastIndexOf("/")+1);l=a=>{var c=new XMLHttpRequest;c.open("GET",a,!1);c.responseType="arraybuffer";c.send(null);return new Uint8Array(c.response)};k=async a=>{a=await fetch(a,{credentials:"same-origin"});if(a.ok)return a.arrayBuffer();throw Error(a.status+" : "+a.url);};var m=b.printErr||console.error.bind(console);
Object.assign(b,e);e=null;var n=b.wasmBinary,p,q=!1,r,t,u,v,w,x;function y(){var a=p.buffer;b.HEAP8=new Int8Array(a);b.HEAP16=new Int16Array(a);b.HEAPU8=t=new Uint8Array(a);b.HEAPU16=new Uint16Array(a);b.HEAP32=u=new Int32Array(a);b.HEAPU32=v=new Uint32Array(a);b.HEAPF32=new Float32Array(a);b.HEAPF64=x=new Float64Array(a);b.HEAP64=w=new BigInt64Array(a);b.HEAPU64=new BigUint64Array(a)}var z=0,A=null;
function B(a){b.onAbort?.(a);a="Aborted("+a+")";m(a);q=!0;throw new WebAssembly.RuntimeError(a+". Build with -sASSERTIONS for more info.");}var C;async function D(a){if(!n)try{var c=await k(a);return new Uint8Array(c)}catch{}if(a==C&&n)a=new Uint8Array(n);else if(l)a=l(a);else throw"both async and sync fetching of the wasm failed";return a}async function E(a,c){try{var d=await D(a);return await WebAssembly.instantiate(d,c)}catch(f){m(`failed to asynchronously prepare wasm: ${f}`),B(f)}}
async function aa(a){var c=C;if(!n&&"function"==typeof WebAssembly.instantiateStreaming)try{var d=fetch(c,{credentials:"same-origin"});return await WebAssembly.instantiateStreaming(d,a)}catch(f){m(`wasm streaming compile failed: ${f}`),m("falling back to ArrayBuffer instantiation")}return E(c,a)}class F{name="ExitStatus";constructor(a){this.message=`Program terminated with exit(${a})`;this.status=a}}
var G=a=>{for(;0<a.length;)a.shift()(b)},H=[],I=[],ba=()=>{var a=b.preRun.shift();I.unshift(a)},J=b.noExitRuntime||!0,K=0,L={},M=a=>{if(!(a instanceof F||"unwind"==a))throw a;},N=a=>{r=a;J||0<K||(b.onExit?.(a),q=!0);throw new F(a);},ca=a=>{if(!q)try{if(a(),!(J||0<K))try{r=a=r,N(a)}catch(c){M(c)}}catch(c){M(c)}},O=[],da={8712:()=>{console.info("WASM Initialised, ready to trace.");P=!0;for(const a of Q)R(a)}},ea={e:()=>B(""),b:()=>{J=!1;K=0},c:(a,c)=>{L[a]&&(clearTimeout(L[a].id),delete L[a]);if(!c)return 0;
var d=setTimeout(()=>{delete L[a];ca(()=>S(a,performance.now()))},c);L[a]={id:d,C:c};return 0},f:(a,c,d)=>{O.length=0;for(var f;f=t[c++];){var g=105!=f;g&=112!=f;d+=g&&d%8?4:0;O.push(112==f?v[d>>2]:106==f?w[d>>3]:105==f?u[d>>2]:x[d>>3]);d+=g?8:4}return da[a](...O)},d:a=>{var c=t.length;a>>>=0;if(2147483648<a)return!1;for(var d=1;4>=d;d*=2){a:{var f=(Math.min(2147483648,65536*Math.ceil(Math.max(a,c+50331648/d)/65536))-p.buffer.byteLength+65535)/65536|0;try{p.grow(f);y();var g=1;break a}catch(W){}g=
void 0}if(g)return!0}return!1},a:N},T;(async function(){function a(d){T=d.exports;p=T.g;y();z--;b.monitorRunDependencies?.(z);0==z&&A&&(d=A,A=null,d());return T}z++;b.monitorRunDependencies?.(z);var c={a:ea};if(b.instantiateWasm)return new Promise(d=>{b.instantiateWasm(c,(f,g)=>{a(f,g);d(f.exports)})});C??=b.locateFile?b.locateFile("a.out.wasm",h):h+"a.out.wasm";return a((await aa(c)).instance)})();b._clean_string=a=>(b._clean_string=T.i)(a);b._create_buffer=(a,c)=>(b._create_buffer=T.j)(a,c);
b._setCurrent=a=>(b._setCurrent=T.k)(a);b._addImage=(a,c,d)=>(b._addImage=T.l)(a,c,d);b._removeImage=a=>(b._removeImage=T.m)(a);b._historyStatus=()=>(b._historyStatus=T.n)();b._trace=(a,c,d)=>(b._trace=T.o)(a,c,d);b._undo=()=>(b._undo=T.p)();b._redo=()=>(b._redo=T.q)();b._clear=()=>(b._clear=T.r)();b._point=(a,c)=>(b._point=T.s)(a,c);b._autoTrace=a=>(b._autoTrace=T.t)(a);b._eraseRegion=(a,c)=>(b._eraseRegion=T.u)(a,c);b._smoothTrace=()=>(b._smoothTrace=T.v)();
b._exportTrace=(a,c,d,f,g,W,fa,ha,ia,ja,ka,la)=>(b._exportTrace=T.w)(a,c,d,f,g,W,fa,ha,ia,ja,ka,la);b._snap=(a,c,d)=>(b._snap=T.x)(a,c,d);b._getPixelColour=(a,c)=>(b._getPixelColour=T.y)(a,c);b._getCurrentPath=()=>(b._getCurrentPath=T.z)();var U=b._main=(a,c)=>(U=b._main=T.A)(a,c),S=(a,c)=>(S=T.B)(a,c);
function V(){function a(){b.calledRun=!0;if(!q){T.h();b.onRuntimeInitialized?.();if(!b.noInitialRun){var c=U;try{var d=c(0,0);r=d;N(d)}catch(f){M(f)}}if(b.postRun)for("function"==typeof b.postRun&&(b.postRun=[b.postRun]);b.postRun.length;)c=b.postRun.shift(),H.unshift(c);G(H)}}if(0<z)A=V;else{if(b.preRun)for("function"==typeof b.preRun&&(b.preRun=[b.preRun]);b.preRun.length;)ba();G(I);0<z?A=V:b.setStatus?(b.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>b.setStatus(""),1);a()},1)):a()}}
if(b.preInit)for("function"==typeof b.preInit&&(b.preInit=[b.preInit]);0<b.preInit.length;)b.preInit.pop()();V();const ma=TextDecoder.prototype.decode.bind(new TextDecoder("utf-8")),X=a=>(...c)=>{c=a(...c);var d=b.HEAPU32;d=ma(new Uint8Array(b.HEAPU8.buffer,d[c/4],d[c/4+1]));b._clean_string(c);return d},Y=new Map;
var na=b._create_buffer,oa=b._historyStatus,pa=X(b._trace),qa=X(b._point),ra=X(b._undo),sa=X(b._redo),ta=X(b._eraseRegion),ua=X(b._smoothTrace),va=b._clear,wa=X(b._autoTrace),xa=X(b._exportTrace),ya=b._snap,za=b._getPixelColour,Aa=X(b._getCurrentPath);
const Z=(a,c)=>{a.svg=c;return a},Ba={setCurrent:a=>b._setCurrent(Y.get(a.src)),removeImage:a=>{a=a.src;b._removeImage(Y.get(a));Y.delete(a)},setData:a=>{const c=na(parseInt(a.width,10),parseInt(a.height,10));b.HEAPU8.set(a.data,c);Y.set(a.src,b._addImage(c,parseInt(a.width,10),parseInt(a.height,10)));return{src:a.src,type:a.type}},getHistoryStatus:a=>{const c=oa();a.undo=!!((c&2)>>1);a.redo=!!(c&1);return a},clearTrace:a=>Z(a,va()),undoTrace:a=>Z(a,ra()),redoTrace:a=>Z(a,sa()),eraseRegion:a=>Z(a,
ta(parseInt(a.begin,10),parseInt(a.end,10))),smoothTrace:a=>Z(a,ua()),exportTrace:a=>{a["export"]=xa(parseInt(a.PPO,10),"tab"===a.delim?1:0,parseFloat(a.lowFR),parseFloat(a.highFR),parseFloat(a.SPL.top),parseFloat(a.SPL.topPixel),parseFloat(a.SPL.bottom),parseFloat(a.SPL.bottomPixel),parseFloat(a.FR.top),parseFloat(a.FR.topPixel),parseFloat(a.FR.bottom),parseFloat(a.FR.bottomPixel));return a},addPoint:a=>Z(a,qa(parseInt(a.x,10),parseInt(a.y,10))),autoTrace:a=>Z(a,wa(parseInt(a.colourTolerance,10))),
trace:a=>Z(a,pa(parseInt(a.x,10),parseInt(a.y,10),parseInt(a.colourTolerance,10))),snapLine:a=>{a.line.position=ya(parseInt(a.line.position),"x"===a.line.direction?1:0,parseInt(a.direction,10));return a},getPixelColour:a=>{const c=za(parseInt(a.x,10),parseInt(a.y,10));a.pixelColour=`${c>>16}, ${c>>8&255}, ${c&255}`;return a},getCurrentPath:a=>Z(a,Aa())};let P=!1;
const Q=[],R=a=>{if(P){a=a.data;let c;try{c=Ba[a.type](a)}catch(d){console.error(d.message),c={type:"error",message:"Out of memory, please refresh the site. (You must have loaded a LOT of images at once)"}}c&&postMessage(c)}else Q.push(a)};self.onmessage=R;
